#!/usr/bin/env node

/**
 * Automatic Commitizen + Husky setup (v9+ compatible)
 * Fully hands-off, runs postinstall on consuming projects.
 */

const { execSync } = require('child_process');
const path = require('path');
const fs = require('fs');

const projectRoot = process.env.INIT_CWD || path.resolve(__dirname, '../../');
const huskyDir = path.join(projectRoot, '.husky');
const hookPath = path.join(huskyDir, 'prepare-commit-msg');

console.log('üß† Initializing Commitizen + Husky setup...');

try {
    process.chdir(projectRoot);

    // Skip if not a git repo
    if (!fs.existsSync(path.join(projectRoot, '.git'))) {
        console.log('‚ö†Ô∏è  Skipping Husky setup (no .git directory found).');
        process.exit(0);
    }

    // 1Ô∏è‚É£ Ensure Husky is installed
    if (!fs.existsSync(huskyDir)) {
        console.log('‚öôÔ∏è  Installing Husky...');
        execSync('npx husky install', { stdio: 'inherit' });
    }

    // 2Ô∏è‚É£ Ensure git hook path is set
    execSync('git config core.hooksPath .husky', { stdio: 'inherit' });

    // 3Ô∏è‚É£ Create prepare-commit-msg hook (no deprecated sourcing)
    const hookContent = `#!/bin/sh

# Interactive Commitizen prompt (Husky v9+ safe)
exec < /dev/tty && npx cz --hook || true
exit 0
`;

    if (!fs.existsSync(hookPath)) {
        console.log('ü™ù Creating prepare-commit-msg hook...');
        fs.writeFileSync(hookPath, hookContent);
        fs.chmodSync(hookPath, 0o755);
    } else {
        const existing = fs.readFileSync(hookPath, 'utf-8');
        if (existing.includes('husky.sh')) {
            console.log('‚ôªÔ∏è  Updating deprecated Husky v8 syntax...');
            fs.writeFileSync(hookPath, hookContent);
            fs.chmodSync(hookPath, 0o755);
        } else {
            console.log('‚úÖ prepare-commit-msg hook already valid.');
        }
    }

    console.log('üéâ Commitizen + Husky are ready! Run `git commit` to open the interactive prompt.');
} catch (err) {
    console.error('‚ùå Commitizen setup failed:', err.message);
    process.exit(0);
}
